import time
import math
import csv
import pyautogui
from pymavlink import mavutil
from pywinauto import Desktop, Application

# =========================
# åŸºæœ¬é…ç½®ï¼ˆæ²¿ç”¨/å¯è°ƒæ•´ï¼‰
# =========================
SCAN_PORTS = [14445]
HEARTBEAT_TIMEOUT = 3.0
SAFE_ROLL = math.radians(45)
SAFE_PITCH = math.radians(45)
OBSERVE_TIME = 240  # æ¯æ¬¡ä¿®æ”¹åç›‘å¬æ—¶é•¿ï¼ˆç§’ï¼‰
STEPS_PER_PARAM = 5  # æ¯ä¸ªå‚æ•°çš„ä¿®æ”¹æ­¥æ•°ï¼ˆä¸å«ç¬¬6æ¬¡è¿˜åŸï¼‰
OUTPUT_CSV = "results.csv"
MAX_ALT = 100.0  # è¶…é«˜åˆ¤å®šï¼ˆå¯è°ƒï¼‰

# =========================
# ä½ çš„ px4_parameters å­—å…¸ï¼ˆè¿™é‡Œè¯·ç”¨ä½ åŸå§‹çš„å¤§å­—å…¸ï¼‰
# =========================
px4_parameters = {
    # ç©ºé€Ÿç›¸å…³å‚æ•°
    "ASPD_SCALE": {"min": 0.5, "max": 1.5, "decimal": 1, "default": 1.0},
    
    # ç”µæ± æ ¡å‡†å‚æ•°
    "BAT1_CAPACITY": {"min": -1, "max": 100000, "decimal": 0, "default": -1},
    "BAT1_N_CELLS": {"min": 2, "max": 16, "decimal": 0, "default": 0},
    "BAT1_R_INTERNAL": {"min": -1, "max": 0.2, "decimal": 3, "default": -1},
    "BAT1_SOURCE": {"min": 0, "max": 1, "decimal": 0, "default": 0},
    "BAT1_V_CHARGED": {"min": 3.0, "max": 4.5, "decimal": 2, "default": 4.05},
    "BAT1_V_EMPTY": {"min": 3.0, "max": 4.0, "decimal": 2, "default": 3.5},
    "BAT1_V_LOAD_DROP": {"min": 0.07, "max": 0.5, "decimal": 2, "default": 0.3},
    
    # ç”µæ± ç”µé‡é˜ˆå€¼
    "BAT_CRIT_THR": {"min": 0.05, "max": 0.1, "decimal": 2, "default": 0.07},
    "BAT_EMERGEN_THR": {"min": 0.03, "max": 0.07, "decimal": 2, "default": 0.05},
    "BAT_LOW_THR": {"min": 0.12, "max": 0.4, "decimal": 2, "default": 0.15},
    
    # ä¼ æ„Ÿå™¨å‚æ•°
    "CAL_AIR_CMODEL": {"min": 0, "max": 2, "decimal": 0, "default": 0},
    "CAL_AIR_TUBED_MM": {"min": 0.1, "max": 100.0, "decimal": 1, "default": 1.5},
    "CAL_AIR_TUBELEN": {"min": 0.01, "max": 2.0, "decimal": 2, "default": 0.2},
    "CAL_MAG_SIDES": {"min": 34, "max": 63, "decimal": 0, "default": 63},
    "IMU_ACCEL_CUTOFF": {"min": 0.0, "max": 1000.0, "decimal": 1, "default": 30.0},
    "IMU_GYRO_CUTOFF": {"min": 0.0, "max": 1000.0, "decimal": 1, "default": 30.0},
    "IMU_GYRO_NF_FREQ": {"min": 0.0, "max": 1000.0, "decimal": 1, "default": 0.0},
    "IMU_GYRO_NF_BW": {"min": 0.0, "max": 100.0, "decimal": 1, "default": 20.0},
    "IMU_DGYRO_CUTOFF": {"min": 0.0, "max": 1000.0, "decimal": 1, "default": 10.0},
    "IMU_GYRO_RATEMAX": {"min": 0, "max": 2000, "decimal": 0, "default": 0},
    "SENS_BOARD_ROT": {"min": 0, "max": 35, "decimal": 0, "default": 0},
    "SENS_BOARD_X_OFF": {"min": -90.0, "max": 90.0, "decimal": 1, "default": 0.0},
    "SENS_BOARD_Y_OFF": {"min": -90.0, "max": 90.0, "decimal": 1, "default": 0.0},
    "SENS_BOARD_Z_OFF": {"min": -90.0, "max": 90.0, "decimal": 1, "default": 0.0},
    "SENS_BARO_QNH": {"min": 500.0, "max": 1500.0, "decimal": 2, "default": 1013.25},
    
    # Commander å‚æ•°
    "COM_ARM_EKF_AB": {"min": 0.0, "max": 0.1, "decimal": 5, "default": 0.00173},
    "COM_ARM_EKF_GB": {"min": 0.0, "max": 0.01, "decimal": 5, "default": 0.00087},
    "COM_ARM_EKF_HGT": {"min": 0.0, "max": 5.0, "decimal": 1, "default": 1.0},
    "COM_ARM_EKF_POS": {"min": 0.0, "max": 5.0, "decimal": 1, "default": 0.5},
    "COM_ARM_EKF_VEL": {"min": 0.0, "max": 5.0, "decimal": 1, "default": 0.5},
    "COM_ARM_EKF_YAW": {"min": 0.0, "max": 5.0, "decimal": 1, "default": 0.5},
    "COM_ARM_IMU_ACC": {"min": 0.0, "max": 5.0, "decimal": 1, "default": 0.7},
    "COM_ARM_IMU_GYR": {"min": 0.0, "max": 1.0, "decimal": 2, "default": 0.25},
    "COM_ARM_MAG_ANG": {"min": -1, "max": 90, "decimal": 0, "default": 30},
    "COM_ARM_MAG_STR": {"min": 0, "max": 1, "decimal": 0, "default": 1},
    "COM_ARM_MIS_REQ": {"min": 0, "max": 1, "decimal": 0, "default": 0},
    "COM_ARM_SWISBTN": {"min": 0, "max": 1, "decimal": 0, "default": 0},
    "COM_ARM_WO_GPS": {"min": 0, "max": 1, "decimal": 0, "default": 1},
    "COM_DISARM_LAND": {"min": 0, "max": 60, "decimal": 0, "default": 2},
    "COM_DISARM_PRFLT": {"min": 0, "max": 60, "decimal": 0, "default": 10},
    "COM_DL_LOSS_T": {"min": 1, "max": 60, "decimal": 0, "default": 10},
    "COM_EF_C2T": {"min": 0.0, "max": 50.0, "decimal": 1, "default": 5.0},
    "COM_EF_THROT": {"min": 0.0, "max": 1.0, "decimal": 2, "default": 0.5},
    "COM_EF_TIME": {"min": 1, "max": 60, "decimal": 0, "default": 10},
    "COM_FLTMODE1": {"min": -1, "max": 20, "decimal": 0, "default": -1},
    "COM_FLTMODE2": {"min": 0, "max": 20, "decimal": 0, "default": 0},
    "COM_FLTMODE3": {"min": 0, "max": 20, "decimal": 0, "default": 0},
    "COM_FLTMODE4": {"min": 0, "max": 20, "decimal": 0, "default": 0},
    "COM_FLTMODE5": {"min": 0, "max": 20, "decimal": 0, "default": 0},
    "COM_FLTMODE6": {"min": 0, "max": 20, "decimal": 0, "default": 0},
    "COM_FLIGHT_UUID": {"min": 0, "max": 1000000, "decimal": 0, "default": 0},
    "COM_FLT_PROFILE": {"min": 0, "max": 300, "decimal": 0, "default": 0},
    "COM_HLDL_LOSS_T": {"min": 1, "max": 300, "decimal": 0, "default": 120},
    "COM_HLDL_REG_T": {"min": 0, "max": 300, "decimal": 0, "default": 0},
    "COM_HOME_H_T": {"min": 0.0, "max": 50.0, "decimal": 1, "default": 5.0},
    "COM_HOME_V_T": {"min": 0.0, "max": 50.0, "decimal": 1, "default": 10.0},
    "COM_KILL_DISARM": {"min": 0.0, "max": 60.0, "decimal": 1, "default": 5.0},
    "COM_LOW_BAT_ACT": {"min": 0, "max": 3, "decimal": 0, "default": 0},
    "COM_OA_BOOT_T": {"min": 0, "max": 300, "decimal": 0, "default": 100},
    "COM_OBL_ACT": {"min": -1, "max": 4, "decimal": 0, "default": 0},
    "COM_OBL_RC_ACT": {"min": 0, "max": 7, "decimal": 0, "default": 0},
    "COM_OF_LOSS_T": {"min": 0.0, "max": 60.0, "decimal": 1, "default": 0.0},
    "COM_POSCTL_NAVL": {"min": 0, "max": 2, "decimal": 0, "default": 0},
    "COM_POS_FS_DELAY": {"min": 0.0, "max": 60.0, "decimal": 1, "default": 1.0},
    "COM_POS_FS_EPH": {"min": 0.0, "max": 50.0, "decimal": 1, "default": 5.0},
    "COM_POS_FS_EPV": {"min": 0.0, "max": 50.0, "decimal": 1, "default": 10.0},
    "COM_POS_FS_GAIN": {"min": 1, "max": 100, "decimal": 0, "default": 10},
    "COM_POS_FS_PROB": {"min": 1, "max": 300, "decimal": 0, "default": 30},
    "COM_PREARM_MODE": {"min": 0, "max": 2, "decimal": 0, "default": 1},
    "COM_RC_STICK_OV": {"min": 0.0, "max": 50.0, "decimal": 1, "default": 12.0},
    "COM_VEL_FS_EVH": {"min": 1.0, "max": 20.0, "decimal": 1, "default": 5.0},
    
    # å¤šæ—‹ç¿¼ä½ç½®æ§åˆ¶å‚æ•°
    "MPC_ACC_HOR": {"min": 1.0, "max": 20.0, "decimal": 1, "default": 3.0},
    "MPC_ACC_HOR_MAX": {"min": 1.0, "max": 20.0, "decimal": 1, "default": 5.0},
    "MPC_ACC_UP_MAX": {"min": 1.0, "max": 20.0, "decimal": 1, "default": 4.0},
    "MPC_JERK_MAX": {"min": 1.0, "max": 100.0, "decimal": 1, "default": 20.0},
    "MPC_JERK_AUTO": {"min": 1.0, "max": 100.0, "decimal": 1, "default": 8.0},
    "MPC_XY_VEL_MAX": {"min": 1.0, "max": 50.0, "decimal": 1, "default": 12.0},
    "MPC_Z_VEL_MAX_UP": {"min": 0.5, "max": 10.0, "decimal": 1, "default": 3.0},
    "MPC_Z_VEL_MAX_DN": {"min": 0.5, "max": 10.0, "decimal": 1, "default": 1.0},
    "MPC_TILTMAX_AIR": {"min": 10.0, "max": 80.0, "decimal": 1, "default": 45.0},
    "MPC_TILTMAX_LND": {"min": 5.0, "max": 30.0, "decimal": 1, "default": 12.0},
    "MPC_MAN_Y_MAX": {"min": 10.0, "max": 360.0, "decimal": 1, "default": 150.0},
    "MPC_MAN_Y_TAU": {"min": 0.0, "max": 1.0, "decimal": 2, "default": 0.08},
    
    # EKF2 å‚æ•°
    "EKF2_ABIAS_INIT": {"min": 0.0, "max": 0.5, "decimal": 3, "default": 0.2},
    "EKF2_ABL_ACCLIM": {"min": 20, "max": 200, "decimal": 0, "default": 25},
    "EKF2_ABL_GYRLIM": {"min": 2.0, "max": 20.0, "decimal": 1, "default": 3.0},
    "EKF2_ABL_LIM": {"min": 0.0, "max": 0.8, "decimal": 2, "default": 0.4},
    "EKF2_ABL_TAU": {"min": 0.1, "max": 1.0, "decimal": 1, "default": 0.5},
    "EKF2_ACC_B_NOISE": {"min": 0.0, "max": 0.01, "decimal": 4, "default": 0.003},
    "EKF2_ACC_NOISE": {"min": 0.01, "max": 1.0, "decimal": 2, "default": 0.35},
    "EKF2_AID_MASK": {"min": 0, "max": 511, "decimal": 0, "default": 1},
    "EKF2_GPS_CHECK": {"min": 0, "max": 511, "decimal": 0, "default": 245},
    "EKF2_GPS_DELAY": {"min": 0, "max": 300, "decimal": 0, "default": 110},
    "EKF2_EV_DELAY": {"min": 0, "max": 300, "decimal": 0, "default": 175},
    "EKF2_EVP_NOISE": {"min": 0.01, "max": 10.0, "decimal": 2, "default": 0.1},
    "EKF2_EVV_NOISE": {"min": 0.01, "max": 10.0, "decimal": 2, "default": 0.1},
    "EKF2_FUSE_BETA": {"min": 0, "max": 1, "decimal": 0, "default": 0},
    "EKF2_MAG_TYPE": {"min": 0, "max": 5, "decimal": 0, "default": 0},
    "EKF2_MAG_GATE": {"min": 1.0, "max": 10.0, "decimal": 1, "default": 3.0},
    
    # Failure Detector å‚æ•°
    "FD_EXT_ATS_EN": {"min": 0, "max": 1, "decimal": 0, "default": 0},
    "FD_EXT_ATS_TRIG": {"min": 1000, "max": 2000, "decimal": 0, "default": 1900},
    "FD_FAIL_P": {"min": 60, "max": 180, "decimal": 0, "default": 60},
    "FD_FAIL_P_TTRI": {"min": 0.02, "max": 5.0, "decimal": 2, "default": 0.3},
    "FD_FAIL_R": {"min": 60, "max": 180, "decimal": 0, "default": 60},
    "FD_FAIL_R_TTRI": {"min": 0.02, "max": 5.0, "decimal": 2, "default": 0.3},
    
    # Geofence å‚æ•°
    "GF_ACTION": {"min": 0, "max": 4, "decimal": 0, "default": 1},
    "GF_ALTMODE": {"min": 0, "max": 1, "decimal": 0, "default": 0},
    "GF_COUNT": {"min": -1, "max": 10, "decimal": 0, "default": -1},
    "GF_MAX_HOR_DIST": {"min": 0.0, "max": 10000.0, "decimal": 1, "default": 0.0},
    "GF_MAX_VER_DIST": {"min": 0.0, "max": 10000.0, "decimal": 1, "default": 0.0},
    "GF_SOURCE": {"min": 0, "max": 1, "decimal": 0, "default": 0},
    
    # å¤šæ—‹ç¿¼è§’é€Ÿç‡æ§åˆ¶å‚æ•°
    "MC_ACRO_EXPO": {"min": 0.0, "max": 1.0, "decimal": 2, "default": 0.69},
    "MC_ACRO_EXPO_Y": {"min": 0.0, "max": 1.0, "decimal": 2, "default": 0.69},
    "MC_ACRO_SUPEXPO": {"min": 0.0, "max": 0.95, "decimal": 2, "default": 0.7},
    "MC_ACRO_SUPEXPOY": {"min": 0.0, "max": 0.95, "decimal": 2, "default": 0.7},
    "MC_ACRO_P_MAX": {"min": 10.0, "max": 2000.0, "decimal": 1, "default": 720.0},
    "MC_ACRO_R_MAX": {"min": 10.0, "max": 2000.0, "decimal": 1, "default": 720.0},
    "MC_ACRO_Y_MAX": {"min": 10.0, "max": 2000.0, "decimal": 1, "default": 540.0},
    "MC_BAT_SCALE_EN": {"min": 0, "max": 1, "decimal": 0, "default": 0},
    
    # å¤šæ—‹ç¿¼å§¿æ€æ§åˆ¶å‚æ•°
    "MC_PITCHRATE_MAX": {"min": 0.0, "max": 1800.0, "decimal": 1, "default": 220.0},
    "MC_PITCH_P": {"min": 0.0, "max": 12.0, "decimal": 1, "default": 6.5},
    "MC_RATT_TH": {"min": 0.0, "max": 1.0, "decimal": 2, "default": 0.8},
    "MC_ROLLRATE_MAX": {"min": 0.0, "max": 1800.0, "decimal": 1, "default": 220.0},
    "MC_ROLL_P": {"min": 0.0, "max": 12.0, "decimal": 1, "default": 6.5},
    "MC_YAWRATE_MAX": {"min": 0.0, "max": 1800.0, "decimal": 1, "default": 200.0},
    "MC_YAW_P": {"min": 0.0, "max": 5.0, "decimal": 1, "default": 2.8},
    "MPC_YAWRAUTO_MAX": {"min": 0.0, "max": 360.0, "decimal": 1, "default": 45.0},
    
    # Mission å‚æ•°
    "MIS_DIST_1WP": {"min": 0, "max": 10000, "decimal": 0, "default": 900},
    "MIS_DIST_WPS": {"min": 0, "max": 10000, "decimal": 0, "default": 900},
    "MIS_LTRMIN_ALT": {"min": -1.0, "max": 80.0, "decimal": 1, "default": -1.0},
    "MIS_MNT_YAW_CTL": {"min": 0, "max": 1, "decimal": 0, "default": 0},
    "MIS_TAKEOFF_ALT": {"min": 0.0, "max": 80.0, "decimal": 1, "default": 2.5},
    "MIS_TAKEOFF_REQ": {"min": 0, "max": 1, "decimal": 0, "default": 0},
    "MIS_YAW_ERR": {"min": 0, "max": 90, "decimal": 0, "default": 12},
    "MIS_YAW_TMT": {"min": -1.0, "max": 20.0, "decimal": 1, "default": -1.0},
    "MPC_YAW_MODE": {"min": 0, "max": 4, "decimal": 0, "default": 0},
    "NAV_ACC_RAD": {"min": 0.05, "max": 200.0, "decimal": 1, "default": 10.0},
    "NAV_FORCE_VT": {"min": 0, "max": 1, "decimal": 0, "default": 1},
    "NAV_FW_ALTL_RAD": {"min": 0.05, "max": 200.0, "decimal": 1, "default": 5.0},
    "NAV_LOITER_RAD": {"min": 25.0, "max": 1000.0, "decimal": 1, "default": 50.0},
    "NAV_TRAFF_AVOID": {"min": 0, "max": 4, "decimal": 0, "default": 1},
    
    # è¿”å›æ¨¡å¼å‚æ•°
    "RTL_CONE_ANG": {"min": 0, "max": 90, "decimal": 0, "default": 0},
    "RTL_DESCEND_ALT": {"min": 2.0, "max": 100.0, "decimal": 1, "default": 30.0},
    "RTL_LAND_DELAY": {"min": -1.0, "max": 300.0, "decimal": 1, "default": -1.0},
    "RTL_MIN_DIST": {"min": 0.5, "max": 100.0, "decimal": 1, "default": 5.0},
    "RTL_RETURN_ALT": {"min": 0.0, "max": 150.0, "decimal": 1, "default": 60.0},
    "RTL_TYPE": {"min": 0, "max": 3, "decimal": 0, "default": 0},
    
    # SD Logging å‚æ•°
    "SDLOG_BOOT_BAT": {"min": 0, "max": 1, "decimal": 0, "default": 0},
    "SDLOG_DIRS_MAX": {"min": 0, "max": 1000, "decimal": 0, "default": 0},
    "SDLOG_MISSION": {"min": 0, "max": 2, "decimal": 0, "default": 0},
    "SDLOG_MODE": {"min": -1, "max": 3, "decimal": 0, "default": 0},
    "SDLOG_PROFILE": {"min": 0, "max": 255, "decimal": 0, "default": 3},
    "SDLOG_UTC_OFFSET": {"min": -1000, "max": 1000, "decimal": 0, "default": 0},
    "SDLOG_UUID": {"min": 0, "max": 1, "decimal": 0, "default": 1},
    
    # ç³»ç»Ÿå‚æ•°
    "SYS_AUTOCONFIG": {"min": 0, "max": 2, "decimal": 0, "default": 0},
    "SYS_AUTOSTART": {"min": 0, "max": 9999999, "decimal": 0, "default": 0},
    "SYS_CAL_TDEL": {"min": 10, "max": 100, "decimal": 0, "default": 24},
    "SYS_CAL_TMAX": {"min": -50, "max": 50, "decimal": 0, "default": 10},
    "SYS_CAL_TMIN": {"min": -50, "max": 50, "decimal": 0, "default": 5},
    "SYS_HAS_BARO": {"min": 0, "max": 1, "decimal": 0, "default": 1},
    "SYS_HAS_MAG": {"min": 0, "max": 1, "decimal": 0, "default": 1},
    "SYS_HITL": {"min": 0, "max": 2, "decimal": 0, "default": 0},
    "SYS_MC_EST_GROUP": {"min": 1, "max": 3, "decimal": 0, "default": 2},
    "SYS_RESTART_TYPE": {"min": 0, "max": 2, "decimal": 0, "default": 2},
    "SYS_STCK_EN": {"min": 0, "max": 1, "decimal": 0, "default": 1},
    
    # ç›¸æœºè§¦å‘å‚æ•°
    "TRIG_MODE": {"min": 0, "max": 4, "decimal": 0, "default": 0},
    "TRIG_INTERFACE": {"min": 1, "max": 4, "decimal": 0, "default": 4},
    
    # VTOL å‚æ•°
    "VT_B_DEC_MSS": {"min": 0.0, "max": 20.0, "decimal": 2, "default": 2.0},
    "VT_B_REV_DEL": {"min": 0.0, "max": 10.0, "decimal": 1, "default": 0.0},
}

# =========================
# è¿æ¥ PX4ï¼ˆmavlinkï¼‰
# =========================
def connect():
    port_list = [14445] + [p for p in range(14440, 14551) if p != 14445]
    for port in port_list:
        try:
            print(f"[æ‰«æ] å°è¯•è¿æ¥ udp:127.0.0.1:{port} ...")
            master = mavutil.mavlink_connection(f'udp:127.0.0.1:{port}')
            master.wait_heartbeat(timeout=2)
            # å¿½ç•¥ sysid=0 çš„å‡å¿ƒè·³
            if master.target_system == 0:
                print(f"[è­¦å‘Š] ç«¯å£ {port} æ”¶åˆ° sysid=0 å‡å¿ƒè·³ï¼Œè·³è¿‡")
                continue
            print(f"[è¿æ¥æˆåŠŸ] ç«¯å£ {port}, sysid={master.target_system}, compid={master.target_component}")
            return master
        except Exception:
            continue
    raise RuntimeError("æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„ MAVLink ç«¯å£ï¼")


# =========================
# ç”Ÿæˆç¡®å®šæ€§çš„æ•°å€¼åºåˆ—ï¼ˆä¸éšæœºï¼‰
# è¿”å›é•¿åº¦ä¸º steps çš„å€¼åˆ—è¡¨
# è‹¥å‚æ•°å°æ•°ä½ä¸º0ï¼Œè¿”å›æ•´æ•°
# å¦‚æœä¼ å…¥ param_config ä¸­åŒ…å« "values" å­—æ®µï¼ˆæ˜¾å¼å€¼åºåˆ—ï¼‰ï¼Œä¼˜å…ˆä½¿ç”¨å®ƒ
# =========================
def generate_values(param_config, steps=STEPS_PER_PARAM):
    if "values" in param_config and isinstance(param_config["values"], (list, tuple)) and len(param_config["values"]) >= steps:
        # å¦‚æœç”¨æˆ·å·²ç»ç›´æ¥æä¾›äº†å€¼åºåˆ—ï¼Œä¼˜å…ˆä½¿ç”¨å‰ steps ä¸ª
        vals = []
        for v in param_config["values"][:steps]:
            if param_config["decimal"] == 0:
                vals.append(int(round(v)))
            else:
                vals.append(round(float(v), param_config["decimal"]))
        return vals

    minv = float(param_config.get("min", 0.0))
    maxv = float(param_config.get("max", minv))
    dec = int(param_config.get("decimal", 2))
    default = param_config.get("default", minv)

    if steps <= 1 or maxv == minv:
        # é€€åŒ–æƒ…å†µï¼Œç›´æ¥è¿”å› default é‡å¤ steps æ¬¡
        val = int(round(default)) if dec == 0 else round(default, dec)
        return [val] * steps

    vals = []
    for i in range(steps):
        # ç­‰é—´éš”ï¼ˆåŒ…å« min ä¸ maxï¼‰
        t = i / (steps - 1)
        v = minv + t * (maxv - minv)
        if dec == 0:
            v = int(round(v))
        else:
            v = round(v, dec)
        vals.append(v)
    return vals

# =========================
# UI æ“ä½œï¼šæŒ‰åæ ‡æœç´¢å¹¶è®¾ç½®å‚æ•°ï¼ˆç”±è°ƒç”¨æ–¹ä¼ å…¥å…·ä½“è¦è®¾ç½®çš„å€¼ï¼‰
# search_and_set_parameter ä»…è´Ÿè´£é€šè¿‡ pyautogui åœ¨ UI ä¸Šé€æ­¥è¾“å…¥æ•°å€¼
# å®ƒä¼šæ‰§è¡Œä½ åŸæœ¬çš„ç‚¹å‡»ã€è¾“å…¥ã€æœ€åçš„æ‹–åŠ¨ï¼ˆä»£è¡¨â€œèµ·é£/æ‰§è¡Œâ€ï¼‰
# è‹¥éœ€è¦è°ƒæ•´åæ ‡æˆ–å»¶è¿Ÿï¼Œè¯·åœ¨æ­¤å‡½æ•°å†…ä¿®æ”¹
# =========================
def bring_qgc_to_front():
    try:
        app = Application(backend="uia").connect(title_re=".*QGroundControl.*")
        window = app.window(title_re=".*QGroundControl.*")
        window.set_focus()
        window.minimize()
        window.restore()
        print("QGroundControl çª—å£å·²ç½®é¡¶å¹¶æ¿€æ´»ã€‚")
        return window
    except Exception as e:
        print("è¿æ¥ QGroundControl å¤±è´¥ï¼š", e)
        return None
def click_qgc_button(window, button_name):
    try:
        btn = window.child_window(title=button_name, control_type="Button")
        btn.wait('ready', timeout=10)
        btn.click_input()
        print(f"å·²ç‚¹å‡»æŒ‰é’®ï¼š{button_name}")
    except Exception as e:
        print(f"ç‚¹å‡»æŒ‰é’®å¤±è´¥ï¼š{button_name}ï¼Œé”™è¯¯ï¼š{e}")

def click_in_window(window_title_re, rel_x, rel_y,click=True,double_click=False):
    desktop = Desktop(backend="uia")
    try:
        win = desktop.window(title_re=window_title_re)
        rect = win.rectangle()
    except Exception as e:
        print("æœªæ‰¾åˆ°çª—å£:", e)
        return
    
    abs_x = rect.left + rel_x
    abs_y = rect.top + rel_y
    print(f"ç‚¹å‡»å±å¹•åæ ‡ï¼š({abs_x}, {abs_y})")
    pyautogui.moveTo(abs_x, abs_y)
    pyautogui.click()
    if click:
        if double_click:
            pyautogui.doubleClick()
            print(f"å·²ç‚¹å‡»çª—å£ '{window_title_re}' ä¸Šçš„ç›¸å¯¹ä½ç½® ({rel_x}, {rel_y})")
        else:
            pyautogui.click()
            print(f"å·²ç‚¹å‡»çª—å£ '{window_title_re}' ä¸Šçš„ç›¸å¯¹ä½ç½® ({rel_x}, {rel_y})")
def drag_in_window(window_title_re, start_rel, end_rel, duration=0.5):
    """
    åœ¨æŒ‡å®šçª—å£å†…ï¼ŒæŒ‰ç›¸å¯¹åæ ‡æ‹–åŠ¨é¼ æ ‡ã€‚
    start_rel å’Œ end_rel éƒ½æ˜¯ (rel_x, rel_y)ï¼Œä»¥çª—å£å·¦ä¸Šè§’ä¸ºåŸºå‡†ã€‚
    """
    desktop = Desktop(backend="uia")
    try:
        win = desktop.window(title_re=window_title_re)
        rect = win.rectangle()
    except Exception as e:
        print("æœªæ‰¾åˆ°çª—å£:", e)
        return False

    # è½¬æ¢ä¸ºç»å¯¹åæ ‡
    start_abs = (rect.left + start_rel[0], rect.top + start_rel[1])
    end_abs   = (rect.left + end_rel[0], rect.top + end_rel[1])

    print(f"æ‹–åŠ¨ï¼š{start_abs} â†’ {end_abs}")
    pyautogui.moveTo(*start_abs, duration=0.2)
    pyautogui.mouseDown()
    pyautogui.moveTo(*end_abs, duration=duration)
    pyautogui.mouseUp()
    return True

def search_and_set_parameter(param_name, param_config, set_value):
    try:
        print(f"æ­£åœ¨è®¾ç½®å‚æ•°: {param_name} -> {set_value}")
        # ä»¥ä¸‹åæ ‡æ²¿ç”¨ä½ åŸè„šæœ¬ï¼ˆå¯æŒ‰éœ€è°ƒæ•´ï¼‰
        qgc_win = bring_qgc_to_front()
        if not qgc_win:
            exit()
        click_in_window(".*QGroundControl.*", 36, 30)   # æ‰“å¼€ Vehicle èœå•ï¼ˆç¤ºä¾‹ï¼‰
        time.sleep(0.5)
        click_qgc_button(qgc_win, "Vehicle Setup")  # æ‰“å¼€ Parameters é¡µé¢ï¼ˆç¤ºä¾‹ï¼‰
        time.sleep(1.0)
        click_qgc_button(qgc_win, "å‚æ•°")
        time.sleep(1.0)

        # ç‚¹å‡»æœç´¢æ¡†å¹¶è¾“å…¥å‚æ•°å
        click_in_window(".*QGroundControl.*", 310, 104)
        time.sleep(0.5)
        pyautogui.hotkey("ctrl", "a")  # å…¨é€‰
        pyperclip.copy(param_name)      # å¤åˆ¶å‚æ•°ååˆ°å‰ªè´´æ¿
        pyautogui.hotkey("ctrl", "v")   # ç²˜è´´
        pyautogui.press("enter")
        time.sleep(0.8)

        # ç‚¹å‡»æ•°å€¼æ¡†ï¼Œåˆ é™¤æ—§å€¼ï¼Œè¾“å…¥æ–°å€¼
        click_in_window(".*QGroundControl.*", 708, 154)
        time.sleep(0.5)
        pyautogui.press("delete")
        time.sleep(0.3)

        pyautogui.typewrite(str(set_value))
        pyautogui.press("enter")
        time.sleep(0.5)
        click_in_window(".*QGroundControl.*", 36, 30)
        time.sleep(0.5)

        # ä½ çš„è„šæœ¬ä¸­æœ€åçš„â€œæ‹–åŠ¨â€åŠ¨ä½œï¼ˆä½ æåˆ°ç›‘æ§åœ¨ç§»åŠ¨é¼ æ ‡ï¼ˆé£æœºèµ·é£åï¼‰æ‰å¼€å§‹ï¼‰
        # è¿™é‡Œä¿ç•™è¯¥æ‹–åŠ¨åŠ¨ä½œï¼Œä¸»æµç¨‹ä¼šåœ¨æ­¤å‡½æ•°æˆåŠŸè¿”å›åç«‹åˆ»å¯åŠ¨ç›‘æ§
        pyautogui.moveTo(652, 145, duration=0.3)
        pyautogui.mouseDown()
        pyautogui.moveTo(987, 155, duration=0.5)
        pyautogui.mouseUp()

        # ä½ çš„è„šæœ¬ä¸­æœ€åçš„â€œæ‹–åŠ¨â€åŠ¨ä½œï¼ˆä½ æåˆ°ç›‘æ§åœ¨ç§»åŠ¨é¼ æ ‡ï¼ˆé£æœºèµ·é£åï¼‰æ‰å¼€å§‹ï¼‰
        # è¿™é‡Œä¿ç•™è¯¥æ‹–åŠ¨åŠ¨ä½œï¼Œä¸»æµç¨‹ä¼šåœ¨æ­¤å‡½æ•°æˆåŠŸè¿”å›åç«‹åˆ»å¯åŠ¨ç›‘æ§
        drag_in_window(".*QGroundControl.*", (652, 145), (1100, 155), duration=0.5)

        print(f"ğŸ‘‰ å‚æ•° {param_name} å·²è®¾ç½®ä¸º {set_value} ï¼ˆUI æ“ä½œå®Œæˆï¼‰")
        return True
    except Exception as e:
        print(f"âŒ è®¾ç½®å‚æ•° {param_name} å¤±è´¥ï¼š{e}")
        return False

# =========================
# é£è¡ŒçŠ¶æ€ç›‘å¬ï¼ˆä¸åŸæ¥ç±»ä¼¼ï¼‰
# monitor_state åœ¨ search_and_set_parameter å®Œæˆæ‹–åŠ¨åè¢«è°ƒç”¨
# è¿”å› (uncontrolled_bool, max_alt)
# =========================
def monitor_state(master, duration=OBSERVE_TIME):
    last_heartbeat = time.time()
    last_print = 0
    current_mode = None
    mission_idx = None
    lat = lon = alt = None
    max_alt = 0.0
    uncontrolled = False

    start_time = time.time()
    print(f"[ç›‘æ§] å¼€å§‹ç›‘å¬é£è¡ŒçŠ¶æ€ï¼Œè§‚å¯Ÿ {duration} ç§’")

    while time.time() - start_time < duration:
        msg = master.recv_match(blocking=True, timeout=1)
        now = time.time()

        if not msg:
            continue

        msg_type = msg.get_type()

        if msg_type == "HEARTBEAT":
            last_heartbeat = now
            try:
                current_mode = mavutil.mode_string_v10(msg)
            except Exception:
                current_mode = None

        if msg_type == "MISSION_CURRENT":
            mission_idx = msg.seq

        if msg_type == "GLOBAL_POSITION_INT":
            lat = msg.lat / 1e7
            lon = msg.lon / 1e7
            alt = msg.relative_alt / 1000.0
            max_alt = max(max_alt, alt)

        if msg_type == "ATTITUDE":
            roll = abs(msg.roll)
            pitch = abs(msg.pitch)
            # è¿™é‡Œç”¨ radians æ¯”è¾ƒï¼ˆä½ å®šä¹‰çš„æ˜¯ SAFE_ROLL/SAFE_PITCHï¼‰
            if roll > SAFE_ROLL or pitch > SAFE_PITCH:
                print(f"[æŠ¥è­¦] å§¿æ€è¶…é™! roll={math.degrees(roll):.1f}Â°, pitch={math.degrees(pitch):.1f}Â°")
                try:
                    master.set_mode(master.mode_mapping().get("HOLD"))
                except Exception:
                    pass
                uncontrolled = True
                break

        if now - last_heartbeat > HEARTBEAT_TIMEOUT:
            print("[æŠ¥è­¦] å¿ƒè·³ä¸¢å¤± > 3ç§’ï¼Œç–‘ä¼¼å¤±è”ï¼")
            try:
                master.set_mode(master.mode_mapping().get("HOLD"))
            except Exception:
                pass
            last_heartbeat = now
            uncontrolled = True
            break

        if alt is not None and alt > MAX_ALT:
            print(f"[æŠ¥è­¦] é«˜åº¦è¿‡é«˜ ({alt:.1f} m) -> åˆ¤ä¸ºå¤±æ§")
            uncontrolled = True
            break

        if now - last_print >= 1:
            last_print = now
            if lat is not None and lon is not None and alt is not None:
                print(f"[çŠ¶æ€] mode={current_mode}, mission_idx={mission_idx}, "
                      f"lat={lat:.7f}, lon={lon:.7f}, alt={alt:.2f} m")
            else:
                print(f"[çŠ¶æ€] mode={current_mode}, mission_idx={mission_idx}, ç­‰å¾…ä½ç½®æ•°æ® ...")

    return uncontrolled, max_alt

# =========================
# ä¸»æµç¨‹ï¼šæŒ‰é¡ºåºå¯¹æ¯ä¸ªå‚æ•°è¿›è¡Œ STEPS_PER_PARAM æ¬¡ç¡®å®šæ€§ä¿®æ”¹ï¼Œ
# æ¯æ¬¡ä¿®æ”¹åè°ƒç”¨ monitor_state ç›‘å¬ OBSERVE_TIME ç§’ã€‚
# ç¬¬ 6 æ¬¡ï¼ˆå³æ‰€æœ‰ steps å®Œæˆåï¼‰è¿˜åŸåˆ° defaultã€‚
# ç»“æœå†™å…¥ CSVã€‚
# =========================

def main():
    master = connect()
    if master is None:
        print("[é”™è¯¯] æœªèƒ½è¿æ¥ä»»ä½•å¯ç”¨ç«¯å£ï¼Œé€€å‡º")
        return

    with open(OUTPUT_CSV, "w", newline="") as f:
        writer = csv.writer(f)
        writer.writerow(["å‚æ•°å", "step_index", "è®¾ç½®å€¼", "å¤±æ§", "æœ€é«˜é«˜åº¦(m)"])
        f.flush()

        # éå†å‚æ•°
        for name, info in px4_parameters.items():
            print(f"\n==== å¼€å§‹æµ‹è¯•å‚æ•°: {name} ====")

            # æ¯ä¸ªå‚æ•°ç”Ÿæˆ5ä¸ªæµ‹è¯•å€¼
            seq = generate_values(info, steps=5)

            for idx, val in enumerate(seq, start=1):
                # (1) ä¿®æ”¹å‚æ•°
                ok = search_and_set_parameter(name, info, val)
                if not ok:
                    writer.writerow([name, idx, val, "set_failed", ""])
                    f.flush()
                    time.sleep(1)
                    continue

                # (2) ç›‘æ§çŠ¶æ€
                uncontrolled, max_alt = monitor_state(master, duration=OBSERVE_TIME, param_name=name)

                # (3) ä¿å­˜ç»“æœ
                writer.writerow([name, idx, val, uncontrolled, max_alt])
                f.flush()
                print(f"[è®°å½•] {name} step {idx} -> å¤±æ§={uncontrolled}, æœ€é«˜é«˜åº¦={max_alt:.1f} m")

                time.sleep(1)

            # (4) æ‰€æœ‰5æ¬¡ä¿®æ”¹å®Œæˆåæ¢å¤é»˜è®¤å€¼
            default_val = info.get("default", seq[-1] if seq else 0)
            print(f"[è¿˜åŸ] å°†å‚æ•° {name} è¿˜åŸä¸ºé»˜è®¤å€¼ {default_val}")
            search_and_set_parameter(name, info, default_val)
            time.sleep(1)

    print(f"\nå…¨éƒ¨å‚æ•°æµ‹è¯•å®Œæˆï¼Œç»“æœä¿å­˜åœ¨ {OUTPUT_CSV}")

if __name__ == "__main__":
    main()
